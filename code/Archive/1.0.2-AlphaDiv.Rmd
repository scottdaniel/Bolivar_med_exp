---
title: "Alpha Diversity"
date: "`r Sys.Date()`"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
library(knitr)
options(max.print="75")
opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, prompt=FALSE, tidy = TRUE, comment = NA, message = FALSE)
opts_knit$set(width=75)

# Loading library here
library(tidyverse)
#library(ggpubr)
library(MASS)
library(segmented)
library(agricolae)

# set path
source("~/Dropbox/42-JCHWANG-RUTGERS/Projects-Rutgers/Src/utils.R")

```
## Initial setup
**Setup color index**
```{r}
# Exposure level
Urban_color <- c("#66c2a5", "#fc8d62", "#8da0cb")
names(Urban_color) <- c("Low", "Medium", "High")
print(Urban_color)
#plot(1:3, 1:3, col = Urban_color, pch = 16, cex = 4)
# Ethnicity
Ethnicity_color <- gg_color_hue(3)
names(Ethnicity_color) <- c("SANEMA", "YEKWANA", "Visitors")
print(Ethnicity_color)

Sanemas <- c("Chajuranha", "Mosenahanha", "Kuyuwininha", "Shianana-Jiyakwanha", "Washudihanha", "Sudukuma")
Yekwana <- c("Kanarakuni", "Fiyakwanha")
```

**Import the data**
```{r}
# Alpha diversities
alpha = readRDS("../data/alpha_imported_all.RDS")
```
```{r class.source='fold-show'}
# Mapping
## This mapping files include all villagers and baseline of visitors of all body sites
mt_ms = readRDS("../data/Mapping_MS_Urban.Rds")
Mapping_work <- mt_ms %>% mutate(Urban = ifelse(Ethnicity=="SANEMA", "Low", ifelse(Village=="Fiyakwanha", "Low", ifelse(SampleGroup=="Visitors", "High", "Medium"))) %>% factor(levels = c("Low", "Medium", "High")), Age_num = as.numeric(Age), Age_num = ifelse(is.na(Age_num), as.numeric(gsub(pattern = "_months", replacement = "", Age, ignore.case = T))/12, Age_num), Age_grp1 = ifelse(Age_num>=18, "Adults", "Children"))
Mapping_work$Age_num[Mapping_work$Age=="4_Days"] <- 0
Mapping_work$Age_num[Mapping_work$Age=="1_day"] <- 0
```

**Set up the Analysis**
```{r}
Work <- merge(alpha, Mapping_work, by = 1) %>% mutate(Age_grp2 = case_when(Age_num<=3 ~ "Age_0-3", Age_num<=8 ~ "Age_3-8", Age_num<18 ~ "Age_8-18", T ~ "Adults"))
```

## Impacts on exposure level
```{r}
models = list()
Indices <- colnames(alpha[c(2, 4:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand")
```

### Feces
#### Initial test (no need to run)
**We first check the faith_pd which described the overall complexity of the microbial community.**
```{r}
BB = "Feces"
AA = "faith_pd"
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
The best model from 2015 includes Urban, Age, Urban:Age interaction and Gender (in decreasing importance).

```{r}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
The best model from 2016 includes Urban, Age, Urban:Age interaction (in decreasing importance), but Gender was not there.


So we will fitting the data with Urban, Age, Urban:Age interaction, and Gender for both years to keep unity.
```{r}
# Final model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")
  fit.final <- lm(as.formula(paste0(AA, " ~ Age_num + Urban + Age_num:Urban + Gender")), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r}
for (YY in Yrs){
  #YY = "2016"
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = c(3))
  summary(fit.seg)
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  plot(fit.seg$model$Age_num, hatvalues(fit.seg))
  plot(fit.seg$model$Age_num, cooks.distance(fit.seg))
  plot(hatvalues(fit.seg), fit.seg$residuals)
}
```


It seems from the residual plots that the point with faith_pd smaller than 10 is dragging the curve down and causing non-random residual. 

```{r}
Work %>% filter(Body_Site==BB, faith_pd<12, SampleGroup=="Villagers")
```
It does appears that many baby are outliers, so re-do the analysis without baby.

#### Modeling without babies
##### faith_pd
Overview
```{r}
BB = "Feces"
AA = "faith_pd"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
Modeling 2015
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
summary(regforward.out)
```
Modeling 2016
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)
# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
Final linear model
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2016"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  plot(fit.seg$model$Age_num, hatvalues(fit.seg))
  plot(fit.seg$model$Age_num, cooks.distance(fit.seg))
  plot(hatvalues(fit.seg), fit.seg$residuals)
  anova(fit.seg, lm_models[[YY]]) %>% print()
  davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
  confint.segmented(fit.seg) %>% print()
  qqnorm(fit.seg$residuals)
  slope(fit.seg) %>% print()
  stick_models[[YY]] <- fit.seg
}
```

Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```

##### observed_otu
Overview
```{r}
BB = "Feces"
AA = "observed_otus"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$observed_otus, fit.seg$fitted.values)
  anova(fit.seg, lm_models[[YY]]) %>% print()
  davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
  confint.segmented(fit.seg) %>% print()
  qqnorm(fit.seg$residuals)
  slope(fit.seg) %>% print()
  stick_models[[YY]] <- fit.seg
}
```

Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```


##### shannon
```{r}
BB = "Feces"
AA = "shannon"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$shannon, fit.seg$fitted.values)
  anova(fit.seg, lm_models[[YY]]) %>% print()
  davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
  confint.segmented(fit.seg) %>% print()
  qqnorm(fit.seg$residuals)
  slope(fit.seg) %>% print()
  stick_models[[YY]] <- fit.seg
}
```

Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```

### Mouth
#### Modeling without babies
##### faith_pd
Overview
```{r}
BB = "Mouth"
AA = "faith_pd"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
For year 2015, only urban and age is significant in determing the faith_pd

```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
In 2016, In addition to Age_num and Urban, the interaction term between age_num and urban is also significant at 0.05.
For consistency, only age_num and urban were included.
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, paste(YY, BB, AA, "same as lm model", sep = "-"), sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```

For mouth, broken stick regression did not significantly better than a simple multiple linear regression. So following graph is made using lm.

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

##### observed_otu
Overview
```{r}
BB = "Mouth"
AA = "observed_otus"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$observed_otus, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
}
```
Again, linear model is sufficiently good

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

##### shannon
```{r}
BB = "Mouth"
AA = "shannon"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$shannon, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```
Again broken stick is not sufficiently better than linear

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

### Nose
#### Modeling without babies
##### faith_pd
```{r}
BB = "Nose"
AA = "faith_pd"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
For year 2015, only urban and age is significant in determing the faith_pd

```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
In 2016, Age_num and Urban as well.

For consistency, only age_num and urban were included.
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  print(paste0("-------Following is for ", YY, "--------------"))
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```
Stick model is better than linear

Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```

##### observed_otu
```{r}
BB = "Nose"
AA = "observed_otus"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num + Urban"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$observed_otus, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```
Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```

##### shannon
```{r}
BB = "Nose"
AA = "shannon"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```

Urban is not significant in both years
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Age_num"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model

```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$shannon, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```
Final selected model
```{r}
models[[BB]][[AA]] = stick_models
```

### Right_Arm
#### Modeling without babies
##### faith_pd
```{r}
BB = "Right_Arm"
AA = "faith_pd"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```

For year 2015, only urban and gender is significant in determing the faith_pd


```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
In 2016, Only Urban

For consistency, only gender and urban were included.

```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```


##### observed_otu
```{r}
BB = "Right_Arm"
AA = "observed_otus"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

##### shannon
```{r}
BB = "Right_Arm"
AA = "shannon"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```

Urban is not significant in both years
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

### Right_Hand
#### Modeling without babies
##### faith_pd
```{r}
BB = "Right_Hand"
AA = "faith_pd"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
In 2016, Only Urban

For consistency, only gender and urban were included.
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender + Age_num"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  print(paste0("-------Following is for ", YY, "--------------"))
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
}
```

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

##### observed_otu
```{r}
BB = "Right_Hand"
AA = "observed_otus"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender + Age_num"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```
Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  print(paste0("-------Following is for ", YY, "--------------"))
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$observed_otus, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```
Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

##### shannon
```{r}
BB = "Right_Hand"
AA = "shannon"

Work_dat <- Work %>% filter(Body_Site==BB, SampleGroup=="Villagers", Age_num>=1)
p <- ggplot(Work_dat, aes(x = Age_num, y = get(AA), color = Urban, shape = Gender)) +
  geom_point(size = 1.5) +
  scale_shape_manual(values = c(16, 21)) +
  scale_color_manual(breaks = names(Urban_color), values = Urban_color) +
  facet_grid(.~Year) +
  theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
  labs(x = "Age (Years)", y = AA, title = BB)
print(p)
```
```{r, eval=FALSE}
# Year 2015
YY = "2015"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```
```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Urban + Gender + Age_num:Urban + Age_num:Gender + Urban:Gender)

anova(regforward.out)
```

```{r}
# Final linear model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.final <- lm(paste0(AA, " ~ Urban + Gender + Age_num"), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r}
stick_models <- list()
for (YY in Yrs){
  #YY = "2015"
  print(paste0("-------Following is for ", YY, "--------------"))
  Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = 9)
  summary(fit.seg) %>% print()
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$shannon, fit.seg$fitted.values)
  qqnorm(fit.seg$residuals)
  if (!"segmented" %in% class(fit.seg)){
    print(paste(YY, BB, AA, "same as lm model", sep = "-"))
  } else {
    anova(fit.seg, lm_models[[YY]]) %>% print()
    davies.test(lm_models[[YY]], seg.Z = ~ Age_num, k = 10) %>% print()
    confint.segmented(fit.seg) %>% print()
    stick_models[[YY]] <- fit.seg
    slope(fit.seg) %>% print()
  }
  
  
}
```

Final selected model
```{r}
models[[BB]][[AA]] = lm_models
```

## Stats check
### Stats on the urban, age, and gender
```{r, eval=FALSE}
Indices <- colnames(alpha[c(2, 4:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand")

lm_results <- list()
duncan_results <- list()

for (AA in Indices){
  for (BB in BodySites){
    for (YY in Yrs){
      Work_dat <- Work %>% filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
      fit.final <- lm(paste0(AA, " ~ Urban + Gender + Age_num"), data = Work_dat)
      print(paste0("--------Below is ANOVA table for year ", YY))
      anova(fit.final) %>% print()
      
      print(paste0("--------Below is coefficient for year ", YY))
      summary(fit.final) %>% print()
      lm_results[[paste(AA, BB, YY, sep = "-")]] <- summary(fit.final)$coefficients[-1, ] %>% as.data.frame() %>% rownames_to_column(var = "Factor") %>% mutate(Year = YY, Body_Sites = BB, Index = AA)
      fit.final.village <- lm(paste0(AA, " ~ Village + Gender + Age_num"), data = Work_dat)
      duncan_results[[paste(AA, BB, YY, sep = "-")]] <- duncan.test(fit.final.village, trt = "Village", console = T)$groups %>% rownames_to_column(var = "Village") %>% mutate(Year = YY, Body_Sites = BB, Index = AA)
      colnames(duncan_results[[paste(AA, BB, YY, sep = "-")]])[2] <- "Value"
    }
  }
}

lm_results_final <- do.call("rbind", lm_results)
lm_results_final$fdr <- p.adjust(lm_results_final$`Pr(>|t|)`, method = "fdr")
duncan_results_final <- do.call("rbind", duncan_results)

write.table(lm_results_final, file = "../data/alpha_lm_stats.txt", sep = "\t", row.names = F, quote = F)

# clip <- pipe("pbcopy", "w")
# write.table(lm_results_final, file = clip, row.names = F, quote = F, sep = "\t")
# close(clip)
```

### within Sanema village effect
```{r}
Indices <- colnames(alpha[c(2, 4:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand")

lm_results <- list()
anova_results <- list()
for (AA in Indices){
  for (BB in BodySites){
    for (YY in Yrs){
      Work_dat <- Work %>% filter(Ethnicity=="SANEMA", Body_Site==BB, Year==YY, SampleGroup=="Villagers", Age_num>=1)
      fit.final <- lm(paste0(AA, " ~ Village + Gender + Age_num"), data = Work_dat)
      print(paste0("--------Below is ANOVA table for year ", YY))
      anova(fit.final) %>% print()
      
      print(paste0("--------Below is coefficient for year ", YY))
      summary(fit.final) %>% print()
      lm_results[[paste(AA, BB, YY, sep = "-")]] <- summary(fit.final)$coefficients[-1, ] %>% as.data.frame() %>% rownames_to_column(var = "Factor") %>% mutate(Year = YY, Body_Sites = BB, Index = AA)
      anova_results[[paste(AA, BB, YY, sep = "-")]] <- as.data.frame(anova(fit.final))[1:3, 4:5] %>% rownames_to_column(var = "Factor") %>% mutate(Year = YY, Body_Sites = BB, Index = AA)
      
    }
  }
}

lm_results_final <- do.call("rbind", lm_results)
anova_results_final <- do.call("rbind", anova_results)

# clip <- pipe("pbcopy", "w")
# write.table(anova_results_final, file = clip, row.names = F, quote = F, sep = "\t")
# close(clip)
```


## Graphs
1. alpha diversity in 2015
```{r}
Indices <- colnames(alpha[c(2, 4:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand")
```
```{r}
model_tbls = data.frame(BodySite = as.character(),
                        Index = as.character(),
                        Year = as.character(),
                        Model = as.character())
for (bb in BodySites){
  for (dd in Indices){
    for(yy in Yrs){
      ff = (models[[bb]][[dd]][[yy]]$terms %>% as.character())[3]
      model_tbls = rbind(model_tbls, cbind(bb, dd, yy, ff))
      
    }
  }
}

dat_new = complete(cbind(Age_num = seq(1, 60, 1), 
                         Urban = c("Low", "Medium"), 
                         Gender = c("F", "M")) %>% 
                     as.data.frame(), Age_num, Urban, Gender) %>% 
  mutate(Age_num = as.numeric(Age_num))

dat_pred = list()
for (bb in BodySites){
  for (dd in Indices){
    for(yy in Yrs){
      dat_pred[[bb]][[dd]][[yy]] = cbind(dat_new, predict(models[[bb]][[dd]][[yy]], newdata = dat_new, interval = "confidence"))
      
    }
  }
}
```

```{r}
yy = "2015"

for (dd in Indices){
  #dd = "faith_pd"
  p_list = list()
  for (bb in BodySites){
    #bb = "Feces"
    dat_ = Work %>% filter(Body_Site==bb, Year==yy, SampleGroup=="Villagers", Age_num>=1)
    dat_pred_ = dat_pred[[bb]][[dd]][[yy]]
    p = ggplot(dat_, aes_string(x = "Age_num", y = dd, color = "Urban", shape = "Gender")) +
      geom_point(size = 1, alpha = 0.5) +
      geom_line(data = dat_pred_, aes(y = fit, linetype = Gender), size = 0.3) +
      geom_ribbon(data = dat_pred_, aes(y = fit, ymin = lwr, ymax = upr, fill = Urban, alpha = Gender), color = NA, show.legend = F) +
      scale_color_manual(values = Urban_color) +
      scale_fill_manual(values = Urban_color) +
      scale_shape_manual(values = c(16, 1)) +
      scale_linetype_manual(values = c(1, 2)) +
      scale_alpha_manual(values = c(0.4, 0.2)) +
      theme_jw(base_size = 10) + theme(aspect.ratio = 0.7, panel.background = element_rect(color = "black"), plot.title = element_text(hjust = 0, vjust = 1), plot.title.position = "panel", legend.key.width = unit(1,"cm"), legend.margin = margin(rep(-3, 4))) +
      labs(color = "Samples points", linetype = "Regression lines", shape = "", x = "Age (Year)") +
      guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, linetype = c(NA, NA)), order = 1), shape = guide_legend(override.aes = list(size = 1.5, alpha = 1), order = 2), linetype = guide_legend(order = 3)) +
      ggtitle(bb)
    p_list[[bb]] = p
  }
  p_f = p_list[["Feces"]] + p_list[["Nose"]] + guide_area() + p_list[["Mouth"]] + p_list[["Right_Arm"]] + p_list[["Right_Hand"]] + plot_layout(guides = "collect", nrow = 2) + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(size = 10, face = "bold"))
  print(p_f)
  set_panel_size(p = p_f, g = patchworkGrob(p_f), file = paste0( "../output/figures/alpha_regression_", dd, "_", yy, ".pdf"), width =  unit(3, "in"), height = unit(2.1, "in"))
}

```


